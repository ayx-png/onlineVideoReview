<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
    <title>Pre-Test</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/pretest.css">

    <!-- Bootstrap -->
    <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" rel="stylesheet"> -->

    <!-- HTML5 shim 和 Respond.js 是为了让 IE8 支持 HTML5 元素和媒体查询（media queries）功能 -->
    <!-- 警告：通过 file:// 协议（就是直接将 html 页面拖拽到浏览器中）访问页面时 Respond.js 不起作用 -->
    <!--[if lt IE 9]>
      <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
    <![endif]-->
</head>

<body>
    <div class="header">
        <div class="col-lg-3 ">
            <img src="images/logo2.a2ebc408.png" alt="logo" class="header-logo">
        </div>
        <div class="col-lg-6 header-title">科云评审系统</div>
    </div>
    <div class="body">
        <img src="./images/IMG_20200915_155804.jpg" alt="background-image" class="background-image blur">
        <div class="body-form">
            <div class="test_form_text">
                <h3>评审系统环境测试</h3>
                <p>开放时间：长期有效</p>
                <p>测试说明：为保证参与会议的质量，本次测试将依次针对网络质量、浏览器版本、摄像头、麦克风等进行测试，请按相关提示进行测试！</p>
            </div>
            <div class="body-camera">
                <section class="experiment" style="width:322px; height:240px;border:1px solid blue; ">
                    <div id="videos-container" style="width:322px; height:240px;">
                    </div>
                </section>
                <section class="experiment" style="text-align:center;border:none; margin-top:10px;">
                    <button id="openCamera">打开摄像头</button>
                    <button id="start-recording" disabled> </button>
                    <button id="save-recording" disabled> </button>
                    <!--<a href="javascript:void(0)" onclick="send()">发送</a>-->
                </section>
            </div>
            <div class="test_form_center">
                <!--注册表单-->
                <form id="testForm" action="user">
                    <!--提交处理请求的标识符-->
                    <table style="margin-top: 25px;">
                        <tr>
                            <td>
                                <p>网络质量检测</p>
                            </td>
                            <td>
                                <div class="network-speed">问题说明：<br>
                                    目前检测到网络质量：####<p id="network-downspeed"></p>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <p>浏览器版本检测</p>
                            </td>
                            <td>
                                <div>问题说明：<br>
                                    目前检测到浏览器版本是<p id="b-information"></p> 。并不能支持视频会议，请点击下载链接 <a
                                        href="https://www.baidu.com/" target="_blank">https://www.baidu.com/</a>，进行浏览器安装，并重新测试！
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <p>调试摄像头</p>
                            </td>
                            <td>
                                <p>问题说明：<br>
                                    目前检测到摄像头未开，请*********；
                                    目前检测到人脸无法识别，请*******；
                                </p>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <p>调试麦克风</p>
                            </td>
                            <td>
                                <p>问题说明：<br>
                                    目前检测到未开麦克风，请*********；
                                </p>
                            </td>
                        </tr>
                    </table>
                </form>
                <button type="button" class="submit" id="create"><a href="./meetingcreate.html">完成检测，下一步</a></button>
            </div>

        </div>


    </div>

    <!-- jQuery (Bootstrap 的所有 JavaScript 插件都依赖 jQuery，所以必须放在前边) -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
    <!-- 加载 Bootstrap 的所有 JavaScript 插件。你也可以根据需要只加载单个插件。 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js"></script>
    <script src="./js/pre-test.js"></script>
    <script src="./js/fileSaver.js"></script>
    <script>
        //网络环境检测
        
        // var downspeed = navigator.connection.downlink * 1024 / 8;
    //     function measureBW () {
    //         return navigator.connection.downlink* 1024 / 8;   
    //     } 
     
    //    $(function(){
    //        setInterval(function(){
    //            var downspeed = measureBW() ;
    //            document.getElementById('network-downspeed').innerHTML = "网速为" + downspeed + "KB/s"+navigator.onLine;
    //         }, 500); 
    //     })
    //     console.log(navigator.connection)
        var times1=0;//用来计数，关闭setinternal防止缓存过多
        var interval1=setInterval("getSpeed()", 1000);
        
        function getSpeed(){

            let startTime = new Date().getTime();
            let img = new Image();
            img.src = "http://127.0.0.1:5500/web/images/logo2.a2ebc408.png?timesStamp=" + startTime;
            let endTime;
            let size =21263; // 图片大小
            let speed;
            img.onload = function(){
                              
                endTime = new Date().getTime();
                speed = parseInt(size / (endTime - startTime));
                var unit = "KB/S";
                if(speed >= 1024){
                    speed = (speed / 1024).toFixed(2);
                    unit = "MB/S";
                }
                document.getElementById("network-downspeed").innerHTML = "当前带宽："+ speed + unit + "<br/>请求用时：" + (endTime - startTime) / 1000 + "s";
            };
            times1++;
            if(times1==300){
                clearInterval(interval1);
            }
        }




        //浏览器版本检测
        //获取浏览器信息
        var browser = getBrowserInfo();
        //根据正则将所有数字、‘.’‘/’全部去掉，剩下浏览器名
        var b_name = (browser + "").replace(/[0-9./]/ig, "");
        //根据正则将所有非数字全部去掉，剩下版本  
        var b_version = parseInt((browser + "").replace(/[^0-9.]/ig, ""));
        console.log("正在使用" + b_name + "浏览器，" + "版本是" + b_version);
        document.getElementById('b-information').innerHTML = b_name + "浏览器，" + "版本是" + b_version;
        //摄像头检测
        var mediaStream;
        var recorderFile;
        var stopRecordCallback;
        var openBtn = document.getElementById("openCamera");
        var startBtn = document.getElementById("start-recording");
        var saveBtn = document.getElementById("save-recording");
        openBtn.onclick = function () {
            this.disabled = true;
            startBtn.disabled = false;
            openCamera();
        };

        startBtn.onclick = function () {
            this.disabled = true;
            startRecord();
        };

        saveBtn.onclick = function () {
            saver();

            // alert('Drop WebM file on Chrome or Firefox. Both can play entire file. VLC player or other players may not work.');
        };

        var mediaRecorder;
        var videosContainer = document.getElementById('videos-container');

        function openCamera() {
            var len = videosContainer.childNodes.length;
            for (var i = 0; i < len; i++) {
                videosContainer.removeChild(videosContainer.childNodes[i]);
            }

            var video = document.createElement('video');

            var videoWidth = 320;
            var videoHeight = 240;

            video.controls = false;
            video.muted = true;
            video.width = videoWidth;
            video.height = videoHeight;
            MediaUtils.getUserMedia(true, false, function (err, stream) {
                if (err) {
                    throw err;
                } else {
                    // 通过 MediaRecorder 记录获取到的媒体流
                    console.log();
                    mediaRecorder = new MediaRecorder(stream);
                    mediaStream = stream;
                    var chunks = [], startTime = 0;
                    video.srcObject = stream;
                    video.play();

                    videosContainer.appendChild(video);
                    mediaRecorder.ondataavailable = function (e) {
                        mediaRecorder.blobs.push(e.data);
                        chunks.push(e.data);
                    };
                    mediaRecorder.blobs = [];

                    mediaRecorder.onstop = function (e) {
                        recorderFile = new Blob(chunks, { 'type': mediaRecorder.mimeType });
                        chunks = [];
                        if (null != stopRecordCallback) {
                            stopRecordCallback();
                        }
                    };
                }
            });
        }

        // 停止录制
        function stopRecord(callback) {
            stopRecordCallback = callback;
            // 终止录制器
            mediaRecorder.stop();
            // 关闭媒体流
            MediaUtils.closeStream(mediaStream);
        }

        var MediaUtils = {
            /**
            * 获取用户媒体设备(处理兼容的问题)
            * @param videoEnable {boolean} - 是否启用摄像头
            * @param audioEnable {boolean} - 是否启用麦克风
            * @param callback {Function} - 处理回调
            */
            getUserMedia: function (videoEnable, audioEnable, callback) {
                navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia
                    || navigator.msGetUserMedia || window.getUserMedia;
                var constraints = { video: videoEnable, audio: audioEnable };
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    navigator.mediaDevices.getUserMedia(constraints).then(function (stream) {
                        callback(false, stream);
                    })['catch'](function (err) {
                        callback(err);
                    });
                } else if (navigator.getUserMedia) {
                    navigator.getUserMedia(constraints, function (stream) {
                        callback(false, stream);
                    }, function (err) {
                        callback(err);
                    });
                } else {
                    callback(new Error('Not support userMedia'));
                }
            },

            /**
            * 关闭媒体流
            * @param stream {MediaStream} - 需要关闭的流
            */
            closeStream: function (stream) {
                if (typeof stream.stop === 'function') {
                    stream.stop();
                }
                else {
                    let trackList = [stream.getAudioTracks(), stream.getVideoTracks()];

                    for (let i = 0; i < trackList.length; i++) {
                        let tracks = trackList[i];
                        if (tracks && tracks.length > 0) {
                            for (let j = 0; j < tracks.length; j++) {
                                let track = tracks[j];
                                if (typeof track.stop === 'function') {
                                    track.stop();
                                }
                            }
                        }
                    }
                }
            }
        };

        function startRecord() {
            mediaRecorder.start();
            setTimeout(function () {
                // 结束
                stopRecord(function () {
                    alert("录制成功!");
                    openBtn.disabled = false;
                    saveBtn.disabled = false;
                    //send();
                });
            }, 5000);
        }

        function saver() {
            var file = new File([recorderFile], 'msr-' + (new Date).toISOString().replace(/:|\./g, '-') + '.mp4', {
                type: 'video/mp4'
            });
            saveAs(file);
        }

        function send() {
            var file = new File([recorderFile], 'msr-' + (new Date).toISOString().replace(/:|\./g, '-') + '.mp4', {
                type: 'video/mp4'
            });
            var data = new FormData();
            data.append("username", "test");
            data.append("userfile", file);

            var req = new XMLHttpRequest();
            req.open("POST", "com.spinsoft.bip.frame.utils.image.saveMp4.biz.ext");
            req.send(data);
        }

    </script>
</body>

</html>